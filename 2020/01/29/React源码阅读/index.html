<!DOCTYPE html>
<html>
    <!-- title -->




<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <meta name="author" content="John Doe">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="John Doe">
    <meta name="keywords" content="Hexo | John Doe">
    <meta name="description" content="">
    <meta name="Cache-Control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>React源码阅读 · Nancy&#39;s Studio</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s 1;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href= /css/style.css?v=20180721 as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="stylesheet" href= /css/mobile.css?v=20180721 media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href= "/assets/pic1.jpg" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script" />
    <link rel="preload" href="/scripts/main.js" as="script" />
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >Nancy&#39;s Studio.</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">React源码阅读</a>
            </div>
    </div>
    
    <a class="home-link" href=/>Nancy's Studio.</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style=








height:50vh;

>
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            React源码阅读
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "React">React</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count">8,598</span> / Reading time: <span class="post-count">49 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2020/01/29</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h1 id="React"><a href="#React" class="headerlink" title="React"></a>React</h1><p>基本组成结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> React = &#123;</span><br><span class="line">  Children: &#123;</span><br><span class="line">    map,</span><br><span class="line">    forEach,</span><br><span class="line">    count,</span><br><span class="line">    toArray,</span><br><span class="line">    only,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  createRef,</span><br><span class="line">  Component,</span><br><span class="line">  PureComponent,</span><br><span class="line"></span><br><span class="line">  createContext,</span><br><span class="line">  forwardRef,</span><br><span class="line">  lazy,</span><br><span class="line">  memo,</span><br><span class="line"></span><br><span class="line">  useCallback,</span><br><span class="line">  useContext,</span><br><span class="line">  useEffect,</span><br><span class="line">  useImperativeHandle,</span><br><span class="line">  useDebugValue,</span><br><span class="line">  useLayoutEffect,</span><br><span class="line">  useMemo,</span><br><span class="line">  useReducer,</span><br><span class="line">  useRef,</span><br><span class="line">  useState,</span><br><span class="line"></span><br><span class="line">  Fragment: REACT_FRAGMENT_TYPE,</span><br><span class="line">  Profiler: REACT_PROFILER_TYPE,</span><br><span class="line">  StrictMode: REACT_STRICT_MODE_TYPE,</span><br><span class="line">  Suspense: REACT_SUSPENSE_TYPE,</span><br><span class="line"></span><br><span class="line">  createElement: __DEV__ ? createElementWithValidation : createElement,</span><br><span class="line">  cloneElement: __DEV__ ? cloneElementWithValidation : cloneElement,</span><br><span class="line">  isValidElement: isValidElement,</span><br><span class="line"></span><br><span class="line">  version: ReactVersion,</span><br><span class="line"></span><br><span class="line">  __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED: ReactSharedInternals,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>截取出一些主要模块的核心代码。</p>
<h2 id="Component和PureComponent"><a href="#Component和PureComponent" class="headerlink" title="Component和PureComponent"></a>Component和PureComponent</h2><h3 id="Component属性"><a href="#Component属性" class="headerlink" title="Component属性"></a>Component属性</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class helpers for the updating state of a component.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params">props, context, updater</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.props = props;</span><br><span class="line">  <span class="keyword">this</span>.context = context;</span><br><span class="line">  <span class="comment">// If a component has string refs, we will assign a different object later.</span></span><br><span class="line">  <span class="keyword">this</span>.refs = emptyObject;</span><br><span class="line">  <span class="comment">// We initialize the default updater but the real one gets injected by the renderer.</span></span><br><span class="line">  <span class="keyword">this</span>.updater = updater || ReactNoopUpdateQueue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ReactNoopUpdateQueue</code> updater更新队列抽象API</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is the abstract API for an update queue.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> ReactNoopUpdateQueue = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Checks whether or not this composite component is mounted.</span></span><br><span class="line"><span class="comment">   * @param &#123;ReactClass&#125; publicInstance The instance we want to test.</span></span><br><span class="line"><span class="comment">   * @return &#123;boolean&#125; True if mounted, false otherwise.</span></span><br><span class="line"><span class="comment">   * @protected</span></span><br><span class="line"><span class="comment">   * @final</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  isMounted: <span class="function"><span class="keyword">function</span>(<span class="params">publicInstance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Forces an update. This should only be invoked when it is known with</span></span><br><span class="line"><span class="comment">   * certainty that we are **not** in a DOM transaction.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * You may want to call this when you know that some deeper aspect of the</span></span><br><span class="line"><span class="comment">   * component's state has changed but `setState` was not called.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param &#123;ReactClass&#125; publicInstance The instance that should rerender.</span></span><br><span class="line"><span class="comment">   * @param &#123;?function&#125; callback Called after component is updated.</span></span><br><span class="line"><span class="comment">   * @param &#123;?string&#125; callerName name of the calling function in the public API.</span></span><br><span class="line"><span class="comment">   * @internal</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  enqueueForceUpdate: <span class="function"><span class="keyword">function</span>(<span class="params">publicInstance, callback, callerName</span>) </span>&#123;</span><br><span class="line">    warnNoop(publicInstance, <span class="string">'forceUpdate'</span>);   <span class="comment">//用于检查实例是否isMounted</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Replaces all of the state. Always use this or `setState` to mutate state.</span></span><br><span class="line"><span class="comment">   * You should treat `this.state` as immutable.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * There is no guarantee that `this.state` will be immediately updated, so</span></span><br><span class="line"><span class="comment">   * accessing `this.state` after calling this method may return the old value.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param &#123;ReactClass&#125; publicInstance The instance that should rerender.</span></span><br><span class="line"><span class="comment">   * @param &#123;object&#125; completeState Next state.</span></span><br><span class="line"><span class="comment">   * @param &#123;?function&#125; callback Called after component is updated.</span></span><br><span class="line"><span class="comment">   * @param &#123;?string&#125; callerName name of the calling function in the public API.</span></span><br><span class="line"><span class="comment">   * @internal</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  enqueueReplaceState: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    publicInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">    completeState,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback,</span></span></span><br><span class="line"><span class="function"><span class="params">    callerName,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    warnNoop(publicInstance, <span class="string">'replaceState'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Sets a subset of the state. This only exists because _pendingState is</span></span><br><span class="line"><span class="comment">   * internal. This provides a merging strategy that is not available to deep</span></span><br><span class="line"><span class="comment">   * properties which is confusing. <span class="doctag">TODO:</span> Expose pendingState or don't use it</span></span><br><span class="line"><span class="comment">   * during the merge.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param &#123;ReactClass&#125; publicInstance The instance that should rerender.</span></span><br><span class="line"><span class="comment">   * @param &#123;object&#125; partialState Next partial state to be merged with state.</span></span><br><span class="line"><span class="comment">   * @param &#123;?function&#125; callback Called after component is updated.</span></span><br><span class="line"><span class="comment">   * @param &#123;?string&#125; Name of the calling function in the public API.</span></span><br><span class="line"><span class="comment">   * @internal</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  enqueueSetState: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    publicInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">    partialState,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback,</span></span></span><br><span class="line"><span class="function"><span class="params">    callerName,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    warnNoop(publicInstance, <span class="string">'setState'</span>);  </span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="setState"><a href="#setState" class="headerlink" title="setState"></a>setState</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;object|function&#125; partialState Next partial state or function to</span></span><br><span class="line"><span class="comment"> * 	      produce next partial state to be merged with current state.</span></span><br><span class="line"><span class="comment"> * @param &#123;?function&#125; callback Called after state is updated.</span></span><br><span class="line"><span class="comment"> * @final</span></span><br><span class="line"><span class="comment"> * @protected</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Component.prototype.setState = <span class="function"><span class="keyword">function</span>(<span class="params">partialState, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 控制传入的partialState类型</span></span><br><span class="line">  invariant(</span><br><span class="line">    <span class="keyword">typeof</span> partialState === <span class="string">'object'</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> partialState === <span class="string">'function'</span> ||</span><br><span class="line">      partialState == <span class="literal">null</span>,</span><br><span class="line">    <span class="string">'setState(...): takes an object of state variables to update or a '</span> +</span><br><span class="line">      <span class="string">'function which returns an object of state variables.'</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">this</span>.updater.enqueueSetState(<span class="keyword">this</span>, partialState, callback, <span class="string">'setState'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="forceUpdate"><a href="#forceUpdate" class="headerlink" title="forceUpdate"></a>forceUpdate</h3><p>强制setState某些已改变的深层state值，这样做shouldComponentUpdate不会被调用，componentWillUpdate和componentDidUpdate将被调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;?function&#125; callback Called after update is complete.</span></span><br><span class="line"><span class="comment"> * @final</span></span><br><span class="line"><span class="comment"> * @protected</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Component.prototype.forceUpdate = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.updater.enqueueForceUpdate(<span class="keyword">this</span>, callback, <span class="string">'forceUpdate'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="PureComponent"><a href="#PureComponent" class="headerlink" title="PureComponent"></a>PureComponent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convenience component with default shallow equality check for sCU.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PureComponent</span>(<span class="params">props, context, updater</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.props = props;</span><br><span class="line">  <span class="keyword">this</span>.context = context;</span><br><span class="line">  <span class="comment">// If a component has string refs, we will assign a different object later.</span></span><br><span class="line">  <span class="keyword">this</span>.refs = emptyObject;</span><br><span class="line">  <span class="keyword">this</span>.updater = updater || ReactNoopUpdateQueue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ComponentDummy</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">ComponentDummy.prototype = Component.prototype;</span><br><span class="line"><span class="keyword">const</span> pureComponentPrototype = (PureComponent.prototype = <span class="keyword">new</span> ComponentDummy());</span><br><span class="line">pureComponentPrototype.constructor = PureComponent;</span><br><span class="line"><span class="comment">// Avoid an extra prototype jump for these methods.</span></span><br><span class="line"><span class="built_in">Object</span>.assign(pureComponentPrototype, Component.prototype);  <span class="comment">// 避免向上查找原型链</span></span><br><span class="line">pureComponentPrototype.isPureReactComponent = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h2 id="ReactElement"><a href="#ReactElement" class="headerlink" title="ReactElement"></a>ReactElement</h2><h3 id="基本构成"><a href="#基本构成" class="headerlink" title="基本构成"></a>基本构成</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; type 用于判断如何创建节点</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; props</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; key</span></span><br><span class="line"><span class="comment"> * @param &#123;string|object&#125; ref</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; owner</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; self</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; source</span></span><br><span class="line"><span class="comment"> * @internal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> ReactElement = <span class="function"><span class="keyword">function</span>(<span class="params">type, key, ref, self, source, owner, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="comment">// This tag allows us to uniquely identify this as a React Element</span></span><br><span class="line">    $$<span class="keyword">typeof</span>: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Built-in properties that belong on the element</span></span><br><span class="line">    type: type,</span><br><span class="line">    key: key,</span><br><span class="line">    ref: ref,</span><br><span class="line">    props: props,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record the component responsible for creating this element.</span></span><br><span class="line">    _owner: owner,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hasOwnProperty = <span class="built_in">Object</span>.prototype.hasOwnProperty;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保留属性</span></span><br><span class="line"><span class="keyword">const</span> RESERVED_PROPS = &#123;</span><br><span class="line">  key: <span class="literal">true</span>,</span><br><span class="line">  ref: <span class="literal">true</span>,</span><br><span class="line">  __self: <span class="literal">true</span>,</span><br><span class="line">  __source: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> propName;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reserved names are extracted</span></span><br><span class="line">  <span class="keyword">const</span> props = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> key = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> ref = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> self = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> source = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 取ref属性</span></span><br><span class="line">    <span class="keyword">if</span> (hasValidRef(config)) &#123;</span><br><span class="line">      ref = config.ref;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 取key属性</span></span><br><span class="line">    <span class="keyword">if</span> (hasValidKey(config)) &#123;</span><br><span class="line">      key = <span class="string">''</span> + config.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self = config.__self === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.__self;</span><br><span class="line">    source = config.__source === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.__source;</span><br><span class="line">    <span class="comment">// 其他属性加到props</span></span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> config) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        hasOwnProperty.call(config, propName) &amp;&amp;</span><br><span class="line">        !RESERVED_PROPS.hasOwnProperty(propName)</span><br><span class="line">      ) &#123;</span><br><span class="line">        props[propName] = config[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Children can be more than one argument, and those are transferred onto</span></span><br><span class="line">  <span class="comment">// the newly allocated props object.</span></span><br><span class="line">  <span class="keyword">const</span> childrenLength = <span class="built_in">arguments</span>.length - <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> (childrenLength === <span class="number">1</span>) &#123;</span><br><span class="line">    props.children = children;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childrenLength &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> childArray = <span class="built_in">Array</span>(childrenLength);</span><br><span class="line">    <span class="comment">// 把第三个及以后的参数都加到childArray</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; childrenLength; i++) &#123;</span><br><span class="line">      childArray[i] = <span class="built_in">arguments</span>[i + <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    props.children = childArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 给没定义值的属性添加默认值</span></span><br><span class="line">  <span class="keyword">if</span> (type &amp;&amp; type.defaultProps) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultProps = type.defaultProps;</span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> defaultProps) &#123;</span><br><span class="line">      <span class="keyword">if</span> (props[propName] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        props[propName] = defaultProps[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> ReactElement(</span><br><span class="line">    type,</span><br><span class="line">    key,</span><br><span class="line">    ref,</span><br><span class="line">    self,</span><br><span class="line">    source,</span><br><span class="line">    ReactCurrentOwner.current,</span><br><span class="line">    props,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cloneElement"><a href="#cloneElement" class="headerlink" title="cloneElement"></a>cloneElement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Clone and return a new ReactElement using element as the starting point.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">cloneElement</span>(<span class="params">element, config, children</span>) </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    !(element === <span class="literal">null</span> || element === <span class="literal">undefined</span>),</span><br><span class="line">    <span class="string">'React.cloneElement(...): The argument must be a React element, but you passed %s.'</span>,</span><br><span class="line">    element,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> propName;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Original props are copied</span></span><br><span class="line">  <span class="keyword">const</span> props = <span class="built_in">Object</span>.assign(&#123;&#125;, element.props);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reserved names are extracted</span></span><br><span class="line">  <span class="keyword">let</span> key = element.key;</span><br><span class="line">  <span class="keyword">let</span> ref = element.ref;</span><br><span class="line">  <span class="comment">// Self is preserved since the owner is preserved.</span></span><br><span class="line">  <span class="keyword">const</span> self = element._self;</span><br><span class="line">  <span class="comment">// Source is preserved since cloneElement is unlikely to be targeted by a</span></span><br><span class="line">  <span class="comment">// transpiler, and the original source is probably a better indicator of the</span></span><br><span class="line">  <span class="comment">// true owner.</span></span><br><span class="line">  <span class="keyword">const</span> source = element._source;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Owner will be preserved, unless ref is overridden</span></span><br><span class="line">  <span class="keyword">let</span> owner = element._owner;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasValidRef(config)) &#123;</span><br><span class="line">      <span class="comment">// Silently steal the ref from the parent.</span></span><br><span class="line">      ref = config.ref;</span><br><span class="line">      owner = ReactCurrentOwner.current;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hasValidKey(config)) &#123;</span><br><span class="line">      key = <span class="string">''</span> + config.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining properties override existing props</span></span><br><span class="line">    <span class="keyword">let</span> defaultProps;</span><br><span class="line">    <span class="keyword">if</span> (element.type &amp;&amp; element.type.defaultProps) &#123;</span><br><span class="line">      defaultProps = element.type.defaultProps;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> config) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        hasOwnProperty.call(config, propName) &amp;&amp;</span><br><span class="line">        !RESERVED_PROPS.hasOwnProperty(propName)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (config[propName] === <span class="literal">undefined</span> &amp;&amp; defaultProps !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="comment">// Resolve default props</span></span><br><span class="line">          props[propName] = defaultProps[propName];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          props[propName] = config[propName];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> childrenLength = <span class="built_in">arguments</span>.length - <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> (childrenLength === <span class="number">1</span>) &#123;</span><br><span class="line">    props.children = children;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childrenLength &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> childArray = <span class="built_in">Array</span>(childrenLength);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; childrenLength; i++) &#123;</span><br><span class="line">      childArray[i] = <span class="built_in">arguments</span>[i + <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    props.children = childArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ReactElement(element.type, key, ref, self, source, owner, props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Verify-ReactElement"><a href="#Verify-ReactElement" class="headerlink" title="Verify ReactElement"></a>Verify ReactElement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;?object&#125; object</span></span><br><span class="line"><span class="comment"> * @return &#123;boolean&#125; True if `object` is a ReactElement.</span></span><br><span class="line"><span class="comment"> * @final</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidElement</span>(<span class="params">object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="keyword">typeof</span> object === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">    object !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    object.$$<span class="keyword">typeof</span> === REACT_ELEMENT_TYPE</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="React-Children"><a href="#React-Children" class="headerlink" title="React Children"></a>React Children</h2><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Maps children that are typically specified as `props.children`.</span></span><br><span class="line"><span class="comment"> * The provided mapFunction(child, key, index) will be called for each leaf child.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;?*&#125; children Children tree container.</span></span><br><span class="line"><span class="comment"> * @param &#123;function(*, int)&#125; func The map function.</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; context Context for mapFunction.</span></span><br><span class="line"><span class="comment"> * @return &#123;object&#125; Object containing the ordered map of results.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapChildren</span>(<span class="params">children, func, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> result = [];</span><br><span class="line">  mapIntoWithKeyPrefixInternal(children, result, <span class="literal">null</span>, func, context);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapIntoWithKeyPrefixInternal</span>(<span class="params">children, array, prefix, func, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> escapedPrefix = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">if</span> (prefix != <span class="literal">null</span>) &#123;</span><br><span class="line">    escapedPrefix = escapeUserProvidedKey(prefix) + <span class="string">'/'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> traverseContext = getPooledTraverseContext(</span><br><span class="line">    array,</span><br><span class="line">    escapedPrefix,</span><br><span class="line">    func,</span><br><span class="line">    context,</span><br><span class="line">  );</span><br><span class="line">  traverseAllChildren(children, mapSingleChildIntoContext, traverseContext);</span><br><span class="line">  releaseTraverseContext(traverseContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//contextPool</span></span><br><span class="line"><span class="keyword">const</span> POOL_SIZE = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> traverseContextPool = [];</span><br><span class="line"><span class="comment">//从contextPool获取context赋值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPooledTraverseContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  mapResult,</span></span></span><br><span class="line"><span class="function"><span class="params">  keyPrefix,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapContext,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (traverseContextPool.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> traverseContext = traverseContextPool.pop();</span><br><span class="line">    traverseContext.result = mapResult;</span><br><span class="line">    traverseContext.keyPrefix = keyPrefix;</span><br><span class="line">    traverseContext.func = mapFunction;</span><br><span class="line">    traverseContext.context = mapContext;</span><br><span class="line">    traverseContext.count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> traverseContext;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      result: mapResult,</span><br><span class="line">      keyPrefix: keyPrefix,</span><br><span class="line">      func: mapFunction,</span><br><span class="line">      context: mapContext,</span><br><span class="line">      count: <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//释放context</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">releaseTraverseContext</span>(<span class="params">traverseContext</span>) </span>&#123;</span><br><span class="line">  traverseContext.result = <span class="literal">null</span>;</span><br><span class="line">  traverseContext.keyPrefix = <span class="literal">null</span>;</span><br><span class="line">  traverseContext.func = <span class="literal">null</span>;</span><br><span class="line">  traverseContext.context = <span class="literal">null</span>;</span><br><span class="line">  traverseContext.count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (traverseContextPool.length &lt; POOL_SIZE) &#123;</span><br><span class="line">    traverseContextPool.push(traverseContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Traverses children that are typically specified as `props.children`, but</span></span><br><span class="line"><span class="comment"> * might also be specified through attributes:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * - `traverseAllChildren(this.props.children, ...)`</span></span><br><span class="line"><span class="comment"> * - `traverseAllChildren(this.props.leftPanelChildren, ...)`</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The `traverseContext` is an optional argument that is passed through the</span></span><br><span class="line"><span class="comment"> * entire traversal. It can be used to store accumulations or anything else that</span></span><br><span class="line"><span class="comment"> * the callback might find relevant.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;?*&#125; children Children tree object.</span></span><br><span class="line"><span class="comment"> * @param &#123;!function&#125; callback To invoke upon traversing each child.</span></span><br><span class="line"><span class="comment"> * @param &#123;?*&#125; traverseContext Context for traversal.</span></span><br><span class="line"><span class="comment"> * @return &#123;!number&#125; The number of children in this subtree.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traverseAllChildren</span>(<span class="params">children, callback, traverseContext</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> traverseAllChildrenImpl(children, <span class="string">''</span>, callback, traverseContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;?*&#125; children Children tree container.</span></span><br><span class="line"><span class="comment"> * @param &#123;!string&#125; nameSoFar Name of the key path so far.</span></span><br><span class="line"><span class="comment"> * @param &#123;!function&#125; callback Callback to invoke with each child found.</span></span><br><span class="line"><span class="comment"> * @param &#123;?*&#125; traverseContext Used to pass information throughout the traversal</span></span><br><span class="line"><span class="comment"> * process.</span></span><br><span class="line"><span class="comment"> * @return &#123;!number&#125; The number of children in this subtree.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traverseAllChildrenImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children,</span></span></span><br><span class="line"><span class="function"><span class="params">  nameSoFar,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback,</span></span></span><br><span class="line"><span class="function"><span class="params">  traverseContext,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">type</span> = <span class="keyword">typeof</span> children;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">'undefined'</span> || <span class="keyword">type</span> === <span class="string">'boolean'</span>) &#123;</span><br><span class="line">    <span class="comment">// All of the above are perceived as null.</span></span><br><span class="line">    children = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> invokeCallback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (children === <span class="literal">null</span>) &#123;</span><br><span class="line">    invokeCallback = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'string'</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'number'</span>:</span><br><span class="line">        invokeCallback = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'object'</span>:</span><br><span class="line">        <span class="keyword">switch</span> (children.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">          <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">case</span> REACT_PORTAL_TYPE:</span><br><span class="line">            invokeCallback = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//only child返回1</span></span><br><span class="line">  <span class="keyword">if</span> (invokeCallback) &#123;</span><br><span class="line">    callback(</span><br><span class="line">      traverseContext,</span><br><span class="line">      children,</span><br><span class="line">      <span class="comment">// If it's the only child, treat the name as if it was wrapped in an array</span></span><br><span class="line">      <span class="comment">// so that it's consistent if the number of children grows.</span></span><br><span class="line">      nameSoFar === <span class="string">''</span> ? SEPARATOR + getComponentKey(children, <span class="number">0</span>) : nameSoFar,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> child;</span><br><span class="line">  <span class="keyword">let</span> nextName;</span><br><span class="line">  <span class="keyword">let</span> subtreeCount = <span class="number">0</span>; <span class="comment">// Count of children found in the current subtree.</span></span><br><span class="line">  <span class="keyword">const</span> nextNamePrefix =</span><br><span class="line">    nameSoFar === <span class="string">''</span> ? SEPARATOR : nameSoFar + SUBSEPARATOR;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">      child = children[i];</span><br><span class="line">      nextName = nextNamePrefix + getComponentKey(child, i);</span><br><span class="line">      subtreeCount += traverseAllChildrenImpl(  <span class="comment">//继续调用自身，递归</span></span><br><span class="line">        child,</span><br><span class="line">        nextName,</span><br><span class="line">        callback,</span><br><span class="line">        traverseContext,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> iteratorFn = getIteratorFn(children);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> iteratorFn === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> iterator = iteratorFn.call(children);</span><br><span class="line">      <span class="keyword">let</span> step;</span><br><span class="line">      <span class="keyword">let</span> ii = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (!(step = iterator.next()).done) &#123;</span><br><span class="line">        child = step.value;</span><br><span class="line">        nextName = nextNamePrefix + getComponentKey(child, ii++);</span><br><span class="line">        subtreeCount += traverseAllChildrenImpl(  </span><br><span class="line">          child,</span><br><span class="line">          nextName,</span><br><span class="line">          callback,</span><br><span class="line">          traverseContext,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">'object'</span>) &#123;</span><br><span class="line">      <span class="comment">// 警告不正确的children类型</span></span><br><span class="line">      <span class="keyword">let</span> addendum = <span class="string">''</span>;</span><br><span class="line">      <span class="keyword">const</span> childrenString = <span class="string">''</span> + children;</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">'Objects are not valid as a React child (found: %s).%s'</span>,</span><br><span class="line">        childrenString === <span class="string">'[object Object]'</span></span><br><span class="line">          ? <span class="string">'object with keys &#123;'</span> + <span class="built_in">Object</span>.keys(children).join(<span class="string">', '</span>) + <span class="string">'&#125;'</span></span><br><span class="line">          : childrenString,</span><br><span class="line">        addendum,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> subtreeCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generate a key string that identifies a component within a set.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; component A component that could contain a manual key.</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; index Index that is used if a manual key is not provided.</span></span><br><span class="line"><span class="comment"> * @return &#123;string&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComponentKey</span>(<span class="params">component, index</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Do some typechecking here since we call this blindly. We want to ensure</span></span><br><span class="line">  <span class="comment">// that we don't block potential future ES APIs.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> component === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">    component !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    component.key != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// Explicit key</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">escape</span>(component.key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Implicit key determined by the index in the set</span></span><br><span class="line">  <span class="keyword">return</span> index.toString(<span class="number">36</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传入的callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapSingleChildIntoContext</span>(<span class="params">bookKeeping, child, childKey</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;result, keyPrefix, func, context&#125; = bookKeeping;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> mappedChild = func.call(context, child, bookKeeping.count++);</span><br><span class="line">  <span class="comment">//先判断是节点还是数组</span></span><br><span class="line">  <span class="comment">//若为数组则再次调用mapIntoWithKeyPrefixInternal，这时会从pool中重新取context</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(mappedChild)) &#123;</span><br><span class="line">    mapIntoWithKeyPrefixInternal(mappedChild, result, childKey, <span class="function"><span class="params">c</span> =&gt;</span> c);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappedChild != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">//判断节点是否合规</span></span><br><span class="line">    <span class="keyword">if</span> (isValidElement(mappedChild)) &#123;</span><br><span class="line">      mappedChild = cloneAndReplaceKey(</span><br><span class="line">        mappedChild,</span><br><span class="line">        <span class="comment">// Keep both the (mapped) and old keys if they differ, just as</span></span><br><span class="line">        <span class="comment">// traverseAllChildren used to do for objects as children</span></span><br><span class="line">        keyPrefix +</span><br><span class="line">          (mappedChild.key &amp;&amp; (!child || child.key !== mappedChild.key)</span><br><span class="line">            ? escapeUserProvidedKey(mappedChild.key) + <span class="string">'/'</span></span><br><span class="line">            : <span class="string">''</span>) +</span><br><span class="line">          childKey,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//合法则直接推入result</span></span><br><span class="line">    result.push(mappedChild);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h3><p>与map类似，只是没有返回result</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Iterates through children that are typically specified as `props.children`.</span></span><br><span class="line"><span class="comment"> * The provided forEachFunc(child, index) will be called for each leaf child.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;?*&#125; children Children tree container.</span></span><br><span class="line"><span class="comment"> * @param &#123;function(*, int)&#125; forEachFunc</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; forEachContext Context for forEachContext.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">forEachChildren</span>(<span class="params">children, forEachFunc, forEachContext</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> traverseContext = getPooledTraverseContext(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    forEachFunc,</span><br><span class="line">    forEachContext,</span><br><span class="line">  );</span><br><span class="line">  traverseAllChildren(children, forEachSingleChild, traverseContext);</span><br><span class="line">  releaseTraverseContext(traverseContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传入的callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">forEachSingleChild</span>(<span class="params">bookKeeping, child, name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;func, context&#125; = bookKeeping;</span><br><span class="line">  func.call(context, child, bookKeeping.count++);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ReactContext"><a href="#ReactContext" class="headerlink" title="ReactContext"></a>ReactContext</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type ReactProviderType&lt;T&gt; = &#123;</span><br><span class="line">  $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span> | number,</span><br><span class="line">  _context: ReactContext&lt;T&gt;,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type ReactContext&lt;T&gt; = &#123;</span><br><span class="line">  $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span> | number,</span><br><span class="line">  Consumer: ReactContext&lt;T&gt;,</span><br><span class="line">  Provider: ReactProviderType&lt;T&gt;,</span><br><span class="line">  _calculateChangedBits: <span class="function">(<span class="params">(a: T, b: T</span>) =&gt;</span> number) | <span class="literal">null</span>,</span><br><span class="line">  _currentValue: T,</span><br><span class="line">  _currentValue2: T,</span><br><span class="line">  _threadCount: number,</span><br><span class="line">  <span class="comment">// DEV only</span></span><br><span class="line">  _currentRenderer?: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  _currentRenderer2?: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContext</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  defaultValue: T,</span></span></span><br><span class="line"><span class="function"><span class="params">  calculateChangedBits: ?(a: T, b: T</span>) =&gt; <span class="title">number</span>,</span></span><br><span class="line"><span class="function">): <span class="title">ReactContext</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (calculateChangedBits === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    calculateChangedBits = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context: ReactContext&lt;T&gt; = &#123;</span><br><span class="line">    $$<span class="keyword">typeof</span>: REACT_CONTEXT_TYPE,</span><br><span class="line">    _calculateChangedBits: calculateChangedBits,</span><br><span class="line">    <span class="comment">// As a workaround to support multiple concurrent renderers, we categorize</span></span><br><span class="line">    <span class="comment">// some renderers as primary and others as secondary. We only expect</span></span><br><span class="line">    <span class="comment">// there to be two concurrent renderers at most: React Native (primary) and</span></span><br><span class="line">    <span class="comment">// Fabric (secondary); React DOM (primary) and React ART (secondary).</span></span><br><span class="line">    <span class="comment">// Secondary renderers store their context values on separate fields.</span></span><br><span class="line">    _currentValue: defaultValue,</span><br><span class="line">    _currentValue2: defaultValue,</span><br><span class="line">    <span class="comment">// Used to track how many concurrent renderers this context currently</span></span><br><span class="line">    <span class="comment">// supports within in a single renderer. Such as parallel server rendering.</span></span><br><span class="line">    _threadCount: <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// These are circular</span></span><br><span class="line">    Provider: (<span class="literal">null</span>: any),</span><br><span class="line">    Consumer: (<span class="literal">null</span>: any),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  context.Provider = &#123;</span><br><span class="line">    $$<span class="keyword">typeof</span>: REACT_PROVIDER_TYPE,</span><br><span class="line">    _context: context,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//let hasWarnedAboutUsingNestedContextConsumers = false;</span></span><br><span class="line">  <span class="comment">//let hasWarnedAboutUsingConsumerProvider = false;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">//...一些检错代码</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    context.Consumer = context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createRef"><a href="#createRef" class="headerlink" title="createRef"></a>createRef</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> RefObject = &#123;|</span><br><span class="line">  current: <span class="built_in">any</span>,</span><br><span class="line">|&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRef</span>(<span class="params"></span>): <span class="title">RefObject</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> refObject = &#123;</span><br><span class="line">    current: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> refObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="memo"><a href="#memo" class="headerlink" title="memo"></a>memo</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">memo</span>&lt;<span class="title">Props</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">type</span>: React$ElementType,</span></span></span><br><span class="line">  compare?: (oldProps: Props, newProps: Props) =&gt; boolean, //浅比较</span><br><span class="line">) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    $$<span class="keyword">typeof</span>: REACT_MEMO_TYPE,</span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    compare: compare === <span class="literal">undefined</span> ? <span class="literal">null</span> : compare,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="forwardRef"><a href="#forwardRef" class="headerlink" title="forwardRef"></a>forwardRef</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">forwardRef</span>&lt;<span class="title">Props</span>, <span class="title">ElementType</span>: <span class="title">React$ElementType</span>&gt;(<span class="params"></span></span></span><br><span class="line">  render: (props: Props, ref: React$Ref&lt;ElementType&gt;) =&gt; React$Node,</span><br><span class="line">) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    $$<span class="keyword">typeof</span>: REACT_FORWARD_REF_TYPE,</span><br><span class="line">    render,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="react-reconciler-React-Fiber"><a href="#react-reconciler-React-Fiber" class="headerlink" title="react-reconciler (React Fiber)"></a>react-reconciler (React Fiber)</h1><h2 id="intro"><a href="#intro" class="headerlink" title="intro"></a>intro</h2><p><strong>React Fiber架构（React的数据结构）</strong></p>
<p>Fiber主要解决的是React15在页面元素过多且频繁刷新的场景下出现掉帧的问题。其根本原因是大量的同步计算任务阻塞了浏览器的 UI 渲染。默认情况下，JS 运算、页面布局和页面绘制都是运行在浏览器的主线程当中，他们之间是互斥的关系。如果 JS 运算持续占用主线程，页面就没法得到及时的更新。当我们调用<code>setState</code>更新页面的时候，React 会遍历应用的所有节点，计算出差异，然后再更新 UI。整个过程是一气呵成，不能被打断的。如果页面元素很多，整个过程占用的时机就可能超过 16 毫秒，就容易出现掉帧的现象。</p>
<p>针对这一问题，React 从框架层面对 web 页面的运行机制做了优化。解决主线程长时间被 JS 运算占用这一问题的基本思路，是将运算切割为多个步骤，分批完成。也就是说在完成一部分任务之后，将控制权交回给浏览器，让浏览器有时间进行页面的渲染。等浏览器忙完之后，再继续之前未完成的任务。</p>
<p>旧版 React 通过递归的方式进行渲染，使用的是 JS 引擎自身的函数调用栈，它会一直执行到栈空为止。而<code>Fiber</code>实现了自己的组件调用栈，它以链表的形式遍历组件树，可以灵活的暂停、继续和丢弃执行的任务。实现方式是使用了浏览器的<code>requestIdleCallback</code>这一 API。官方的解释是这样的：</p>
<blockquote>
<p>window.requestIdleCallback()会在浏览器空闲时期依次调用函数，这就可以让开发者在主事件循环中执行后台或低优先级的任务，而且不会对像动画和用户交互这些延迟触发但关键的事件产生影响。函数一般会按先进先调用的顺序执行，除非函数在浏览器调用它之前就到了它的超时时间。</p>
</blockquote>
<p>Fiber Reconciler 每执行一段时间，都会将控制权交回给浏览器，可以分段执行。为了达到这种效果，就需要有一个调度器 (Scheduler) 来进行任务分配。任务的优先级有六种：</p>
<ul>
<li>synchronous，与之前的Stack Reconciler操作一样，同步执行</li>
<li>task，在next tick之前执行</li>
<li>animation，下一帧之前执行</li>
<li>high，在不久的将来立即执行</li>
<li>low，稍微延迟执行也没关系</li>
<li>offscreen，下一次render时或scroll时才执行</li>
</ul>
<p>优先级高的任务（如键盘输入）可以打断优先级低的任务（如Diff）的执行，从而更快的生效。</p>
<p>Fiber Reconciler 在执行过程中，会分为 2 个阶段：</p>
<ul>
<li><p>阶段一（<code>reconciliation</code>），生成 Fiber 树，得出需要更新的节点信息。这一步是一个渐进的过程，可以被打断。</p>
<p>涉及到的生命周期：componentWillMount、componentWillReceiveProps、shouldComponentUpdate、componentWillUpdate</p>
<p>因为 <code>reconciliation</code> 阶段是可以被打断的，所以 <code>reconciliation</code> 阶段会执行的生命周期函数就可能会出现调用多次的情况，从而引起 Bug。所以对于 <code>reconciliation</code> 阶段调用的几个函数，除了 <code>shouldComponentUpdate</code> 以外，其他都应该避免去使用，并且 React16 中也引入了新的 API 来解决这个问题，<code>getDerivedStateFromProps</code>取代了原来的<code>componentWillMount</code>与<code>componentWillReceiveProps</code>方法，该函数会在组件初始化和更新时被调用。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Initialize state in constructor,</span></span><br><span class="line">  <span class="comment">// Or with a property initializer.</span></span><br><span class="line">  state = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> getDerivedStateFromProps(nextProps, prevState) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevState.someMirroredValue !== nextProps.someValue) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        derivedData: computeDerivedState(nextProps),</span><br><span class="line">        someMirroredValue: nextProps.someValue</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return null to indicate no change to state.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>阶段二（<code>commit</code>），将需要更新的节点一次过批量更新，这个过程不能被打断。</p>
<p>涉及到的生命周期：componentDidMount、componentDidUpdate、componentWillUnmount</p>
<p>新引入的<code>getSnapshotBeforeUpdate</code> 用于替换 <code>componentWillUpdate</code> ，该函数会在 <code>update</code> 后 DOM 更新前被调用，用于读取最新的 DOM 数据。 </p>
</li>
</ul>
<p>阶段一可被打断的特性让优先级更高的任务先执行，从框架层面大大降低了页面掉帧的概率。</p>
<p>Fiber Reconciler 在阶段一进行 Diff 计算的时候，会生成一棵 Fiber 树。这棵树是在 Virtual DOM 树的基础上增加额外的信息来生成的，它本质来说是一个链表，主要是为了将递归遍历转变成循环遍历，配合 requestIdleCallback API，实现任务拆分、中断与恢复。每一个 Fiber Node 节点与 Virtual Dom 一一对应，所有 Fiber Node 连接起来形成 Fiber tree, 是个单链表树结构。</p>
<p>Fiber 树在首次渲染的时候会一次过生成。在后续需要 Diff 的时候，会根据已有树和最新 Virtual DOM 的信息，生成一棵新的树。这颗新树每生成一个新的节点，都会将控制权交回给主线程，去检查有没有优先级更高的任务需要执行，如果没有则继续构建树的过程；如果有则 Fiber Reconciler 会丢弃正在生成的树，在空闲的时候再重新执行一遍。 </p>
<p>在构造 Fiber 树的过程中，Fiber Reconciler 会将需要更新的节点信息保存在<code>Effect List</code>当中，在阶段二执行的时候，会批量更新相应的节点。 </p>
<h2 id="ReactFiber"><a href="#ReactFiber" class="headerlink" title="ReactFiber"></a>ReactFiber</h2><p>Fiber的基本构成</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Fiber is work on a Component that needs to be done or was done. There can</span></span><br><span class="line"><span class="comment">// be more than one per component.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Fiber = &#123;|</span><br><span class="line">  <span class="comment">// These first fields are conceptually members of an Instance. This used to</span></span><br><span class="line">  <span class="comment">// be split into a separate type and intersected with the other Fiber fields,</span></span><br><span class="line">  <span class="comment">// but until Flow fixes its intersection bugs, we've merged them into a</span></span><br><span class="line">  <span class="comment">// single type.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// An Instance is shared between all versions of a component. We can easily</span></span><br><span class="line">  <span class="comment">// break this out into a separate object to avoid copying so much to the</span></span><br><span class="line">  <span class="comment">// alternate versions of the tree. We put this on a single object for now to</span></span><br><span class="line">  <span class="comment">// minimize the number of objects created during the initial render.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tag identifying the type of fiber.</span></span><br><span class="line">  tag: WorkTag,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Unique identifier of this child.</span></span><br><span class="line">  key: <span class="literal">null</span> | <span class="built_in">string</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The value of element.type which is used to preserve the identity during</span></span><br><span class="line">  <span class="comment">// reconciliation of this child.</span></span><br><span class="line">  elementType: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The resolved function/class/ associated with this fiber.</span></span><br><span class="line">  <span class="keyword">type</span>: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The local state associated with this fiber.</span></span><br><span class="line">  stateNode: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conceptual aliases</span></span><br><span class="line">  <span class="comment">// parent : Instance -&gt; return The parent happens to be the same as the</span></span><br><span class="line">  <span class="comment">// return fiber since we've merged the fiber and instance.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remaining fields belong to Fiber</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The Fiber to return to after finishing processing this one.</span></span><br><span class="line">  <span class="comment">// This is effectively the parent, but there can be multiple parents (two)</span></span><br><span class="line">  <span class="comment">// so this is only the parent of the thing we're currently processing.</span></span><br><span class="line">  <span class="comment">// It is conceptually the same as the return address of a stack frame.</span></span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Singly Linked List Tree Structure.</span></span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">  index: <span class="built_in">number</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The ref last used to attach this node.</span></span><br><span class="line">  <span class="comment">// I'll avoid adding an owner field for prod and model that as functions.</span></span><br><span class="line">  ref:</span><br><span class="line">    | <span class="literal">null</span></span><br><span class="line">    | <span class="function">(<span class="params">(<span class="params">(<span class="params">handle: mixed</span>) =&gt; <span class="built_in">void</span></span>) &amp; &#123;_stringRef: ?<span class="built_in">string</span>, ...&#125;</span>)</span></span><br><span class="line"><span class="function">    | <span class="params">RefObject</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Input</span> <span class="params">is</span> <span class="params">the</span> <span class="params">data</span> <span class="params">coming</span> <span class="params">into</span> <span class="params">process</span> <span class="params">this</span> <span class="params">fiber</span>. <span class="params">Arguments</span>. <span class="params">Props</span>.</span></span><br><span class="line"><span class="function">  <span class="params">pendingProps</span>: <span class="params">any</span>, // <span class="params">This</span> <span class="params">type</span> <span class="params">will</span> <span class="params">be</span> <span class="params">more</span> <span class="params">specific</span> <span class="params">once</span> <span class="params">we</span> <span class="params">overload</span> <span class="params">the</span> <span class="params">tag</span>.</span></span><br><span class="line"><span class="function">  <span class="params">memoizedProps</span>: <span class="params">any</span>, // <span class="params">The</span> <span class="params">props</span> <span class="params">used</span> <span class="params">to</span> <span class="params">create</span> <span class="params">the</span> <span class="params">output</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">A</span> <span class="params">queue</span> <span class="params">of</span> <span class="params">state</span> <span class="params">updates</span> <span class="params">and</span> <span class="params">callbacks</span>.</span></span><br><span class="line"><span class="function">  <span class="params">updateQueue</span>: <span class="params">UpdateQueue</span>&lt;<span class="params">any</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">The</span> <span class="params">state</span> <span class="params">used</span> <span class="params">to</span> <span class="params">create</span> <span class="params">the</span> <span class="params">output</span></span></span><br><span class="line"><span class="function">  <span class="params">memoizedState</span>: <span class="params">any</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Dependencies</span> (<span class="params">contexts, events</span>) <span class="params">for</span> <span class="params">this</span> <span class="params">fiber</span>, <span class="params">if</span> <span class="params">it</span> <span class="params">has</span> <span class="params">any</span></span></span><br><span class="line"><span class="function">  <span class="params">dependencies</span>: <span class="params">Dependencies</span> | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Bitfield</span> <span class="params">that</span> <span class="params">describes</span> <span class="params">properties</span> <span class="params">about</span> <span class="params">the</span> <span class="params">fiber</span> <span class="params">and</span> <span class="params">its</span> <span class="params">subtree</span>. <span class="params">E</span>.<span class="params">g</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">the</span> <span class="params">ConcurrentMode</span> <span class="params">flag</span> <span class="params">indicates</span> <span class="params">whether</span> <span class="params">the</span> <span class="params">subtree</span> <span class="params">should</span> <span class="params">be</span> <span class="params">async</span>-<span class="params">by</span>-</span></span><br><span class="line"><span class="function">  // <span class="params">default</span>. <span class="params">When</span> <span class="params">a</span> <span class="params">fiber</span> <span class="params">is</span> <span class="params">created</span>, <span class="params">it</span> <span class="params">inherits</span> <span class="params">the</span> <span class="params">mode</span> <span class="params">of</span> <span class="params">its</span></span></span><br><span class="line"><span class="function">  // <span class="params">parent</span>. <span class="params">Additional</span> <span class="params">flags</span> <span class="params">can</span> <span class="params">be</span> <span class="params">set</span> <span class="params">at</span> <span class="params">creation</span> <span class="params">time</span>, <span class="params">but</span> <span class="params">after</span> <span class="params">that</span> <span class="params">the</span></span></span><br><span class="line"><span class="function">  // <span class="params">value</span> <span class="params">should</span> <span class="params">remain</span> <span class="params">unchanged</span> <span class="params">throughout</span> <span class="params">the</span> <span class="params">fiber</span>'<span class="params">s</span> <span class="params">lifetime</span>, <span class="params">particularly</span></span></span><br><span class="line"><span class="function">  // <span class="params">before</span> <span class="params">its</span> <span class="params">child</span> <span class="params">fibers</span> <span class="params">are</span> <span class="params">created</span>.</span></span><br><span class="line"><span class="function">  <span class="params">mode</span>: <span class="params">TypeOfMode</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Effect</span></span></span><br><span class="line"><span class="function">  <span class="params">effectTag</span>: <span class="params">SideEffectTag</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Singly</span> <span class="params">linked</span> <span class="params">list</span> <span class="params">fast</span> <span class="params">path</span> <span class="params">to</span> <span class="params">the</span> <span class="params">next</span> <span class="params">fiber</span> <span class="params">with</span> <span class="params">side</span>-<span class="params">effects</span>.</span></span><br><span class="line"><span class="function">  <span class="params">nextEffect</span>: <span class="params">Fiber</span> | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">The</span> <span class="params">first</span> <span class="params">and</span> <span class="params">last</span> <span class="params">fiber</span> <span class="params">with</span> <span class="params">side</span>-<span class="params">effect</span> <span class="params">within</span> <span class="params">this</span> <span class="params">subtree</span>. <span class="params">This</span> <span class="params">allows</span></span></span><br><span class="line"><span class="function">  // <span class="params">us</span> <span class="params">to</span> <span class="params">reuse</span> <span class="params">a</span> <span class="params">slice</span> <span class="params">of</span> <span class="params">the</span> <span class="params">linked</span> <span class="params">list</span> <span class="params">when</span> <span class="params">we</span> <span class="params">reuse</span> <span class="params">the</span> <span class="params">work</span> <span class="params">done</span> <span class="params">within</span></span></span><br><span class="line"><span class="function">  // <span class="params">this</span> <span class="params">fiber</span>.</span></span><br><span class="line"><span class="function">  <span class="params">firstEffect</span>: <span class="params">Fiber</span> | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">  <span class="params">lastEffect</span>: <span class="params">Fiber</span> | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Represents</span> <span class="params">a</span> <span class="params">time</span> <span class="params">in</span> <span class="params">the</span> <span class="params">future</span> <span class="params">by</span> <span class="params">which</span> <span class="params">this</span> <span class="params">work</span> <span class="params">should</span> <span class="params">be</span> <span class="params">completed</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">Does</span> <span class="params">not</span> <span class="params">include</span> <span class="params">work</span> <span class="params">found</span> <span class="params">in</span> <span class="params">its</span> <span class="params">subtree</span>.</span></span><br><span class="line"><span class="function">  <span class="params">expirationTime</span>: <span class="params">ExpirationTime</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">is</span> <span class="params">used</span> <span class="params">to</span> <span class="params">quickly</span> <span class="params">determine</span> <span class="params">if</span> <span class="params">a</span> <span class="params">subtree</span> <span class="params">has</span> <span class="params">no</span> <span class="params">pending</span> <span class="params">changes</span>.</span></span><br><span class="line"><span class="function">  <span class="params">childExpirationTime</span>: <span class="params">ExpirationTime</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">is</span> <span class="params">a</span> <span class="params">pooled</span> <span class="params">version</span> <span class="params">of</span> <span class="params">a</span> <span class="params">Fiber</span>. <span class="params">Every</span> <span class="params">fiber</span> <span class="params">that</span> <span class="params">gets</span> <span class="params">updated</span> <span class="params">will</span></span></span><br><span class="line"><span class="function">  // <span class="params">eventually</span> <span class="params">have</span> <span class="params">a</span> <span class="params">pair</span>. <span class="params">There</span> <span class="params">are</span> <span class="params">cases</span> <span class="params">when</span> <span class="params">we</span> <span class="params">can</span> <span class="params">clean</span> <span class="params">up</span> <span class="params">pairs</span> <span class="params">to</span> <span class="params">save</span></span></span><br><span class="line"><span class="function">  // <span class="params">memory</span> <span class="params">if</span> <span class="params">we</span> <span class="params">need</span> <span class="params">to</span>.</span></span><br><span class="line"><span class="function">  <span class="params">alternate</span>: <span class="params">Fiber</span> | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Time</span> <span class="params">spent</span> <span class="params">rendering</span> <span class="params">this</span> <span class="params">Fiber</span> <span class="params">and</span> <span class="params">its</span> <span class="params">descendants</span> <span class="params">for</span> <span class="params">the</span> <span class="params">current</span> <span class="params">update</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">tells</span> <span class="params">us</span> <span class="params">how</span> <span class="params">well</span> <span class="params">the</span> <span class="params">tree</span> <span class="params">makes</span> <span class="params">use</span> <span class="params">of</span> <span class="params">sCU</span> <span class="params">for</span> <span class="params">memoization</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">It</span> <span class="params">is</span> <span class="params">reset</span> <span class="params">to</span> 0 <span class="params">each</span> <span class="params">time</span> <span class="params">we</span> <span class="params">render</span> <span class="params">and</span> <span class="params">only</span> <span class="params">updated</span> <span class="params">when</span> <span class="params">we</span> <span class="params">don</span>'<span class="params">t</span> <span class="params">bailout</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">field</span> <span class="params">is</span> <span class="params">only</span> <span class="params">set</span> <span class="params">when</span> <span class="params">the</span> <span class="params">enableProfilerTimer</span> <span class="params">flag</span> <span class="params">is</span> <span class="params">enabled</span>.</span></span><br><span class="line"><span class="function">  <span class="params">actualDuration</span>?: <span class="params">number</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">If</span> <span class="params">the</span> <span class="params">Fiber</span> <span class="params">is</span> <span class="params">currently</span> <span class="params">active</span> <span class="params">in</span> <span class="params">the</span> "<span class="params">render</span>" <span class="params">phase</span>,</span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">marks</span> <span class="params">the</span> <span class="params">time</span> <span class="params">at</span> <span class="params">which</span> <span class="params">the</span> <span class="params">work</span> <span class="params">began</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">field</span> <span class="params">is</span> <span class="params">only</span> <span class="params">set</span> <span class="params">when</span> <span class="params">the</span> <span class="params">enableProfilerTimer</span> <span class="params">flag</span> <span class="params">is</span> <span class="params">enabled</span>.</span></span><br><span class="line"><span class="function">  <span class="params">actualStartTime</span>?: <span class="params">number</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Duration</span> <span class="params">of</span> <span class="params">the</span> <span class="params">most</span> <span class="params">recent</span> <span class="params">render</span> <span class="params">time</span> <span class="params">for</span> <span class="params">this</span> <span class="params">Fiber</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">value</span> <span class="params">is</span> <span class="params">not</span> <span class="params">updated</span> <span class="params">when</span> <span class="params">we</span> <span class="params">bailout</span> <span class="params">for</span> <span class="params">memoization</span> <span class="params">purposes</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">field</span> <span class="params">is</span> <span class="params">only</span> <span class="params">set</span> <span class="params">when</span> <span class="params">the</span> <span class="params">enableProfilerTimer</span> <span class="params">flag</span> <span class="params">is</span> <span class="params">enabled</span>.</span></span><br><span class="line"><span class="function">  <span class="params">selfBaseDuration</span>?: <span class="params">number</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Sum</span> <span class="params">of</span> <span class="params">base</span> <span class="params">times</span> <span class="params">for</span> <span class="params">all</span> <span class="params">descendants</span> <span class="params">of</span> <span class="params">this</span> <span class="params">Fiber</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">value</span> <span class="params">bubbles</span> <span class="params">up</span> <span class="params">during</span> <span class="params">the</span> "<span class="params">complete</span>" <span class="params">phase</span>.</span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">field</span> <span class="params">is</span> <span class="params">only</span> <span class="params">set</span> <span class="params">when</span> <span class="params">the</span> <span class="params">enableProfilerTimer</span> <span class="params">flag</span> <span class="params">is</span> <span class="params">enabled</span>.</span></span><br><span class="line"><span class="function">  <span class="params">treeBaseDuration</span>?: <span class="params">number</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Conceptual</span> <span class="params">aliases</span></span></span><br><span class="line"><span class="function">  // <span class="params">workInProgress</span> : <span class="params">Fiber</span> -&gt;  <span class="params">alternate</span> <span class="params">The</span> <span class="params">alternate</span> <span class="params">used</span> <span class="params">for</span> <span class="params">reuse</span> <span class="params">happens</span></span></span><br><span class="line"><span class="function">  // <span class="params">to</span> <span class="params">be</span> <span class="params">the</span> <span class="params">same</span> <span class="params">as</span> <span class="params">work</span> <span class="params">in</span> <span class="params">progress</span>.</span></span><br><span class="line"><span class="function">  // __<span class="params">DEV__</span> <span class="params">only</span></span></span><br><span class="line"><span class="function">  _<span class="params">debugID</span>?: <span class="params">number</span>,</span></span><br><span class="line"><span class="function">  _<span class="params">debugSource</span>?: <span class="params">Source</span> | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">  _<span class="params">debugOwner</span>?: <span class="params">Fiber</span> | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">  _<span class="params">debugIsCurrentlyTiming</span>?: <span class="params">boolean</span>,</span></span><br><span class="line"><span class="function">  _<span class="params">debugNeedsRemount</span>?: <span class="params">boolean</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Used</span> <span class="params">to</span> <span class="params">verify</span> <span class="params">that</span> <span class="params">the</span> <span class="params">order</span> <span class="params">of</span> <span class="params">hooks</span> <span class="params">does</span> <span class="params">not</span> <span class="params">change</span> <span class="params">between</span> <span class="params">renders</span>.</span></span><br><span class="line"><span class="function">  _<span class="params">debugHookTypes</span>?: <span class="params">Array</span>&lt;<span class="params">HookType</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">|&#125;;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="params">function</span> <span class="params">FiberNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="literal">null</span> | <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) &#123;</span></span><br><span class="line"><span class="function">  // <span class="params">Instance</span></span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">tag</span> = <span class="params">tag</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">key</span> = <span class="params">key</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">elementType</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">type</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">stateNode</span> = <span class="params">null</span>;   //节点实例</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Fiber</span></span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">return</span> = <span class="params">null</span>;   //父节点</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">child</span> = <span class="params">null</span>;    //子节点</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">sibling</span> = <span class="params">null</span>;   //兄弟节点</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">index</span> = 0;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">ref</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">pendingProps</span> = <span class="params">pendingProps</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">memoizedProps</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">updateQueue</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">memoizedState</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">dependencies</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">mode</span> = <span class="params">mode</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">Effects</span></span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">effectTag</span> = <span class="params">NoEffect</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">nextEffect</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">firstEffect</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">lastEffect</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">expirationTime</span> = <span class="params">NoWork</span>;</span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">childExpirationTime</span> = <span class="params">NoWork</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">this</span>.<span class="params">alternate</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">enableProfilerTimer</span>) &#123;</span></span><br><span class="line"><span class="function">    // <span class="params">Note</span>: <span class="params">The</span> <span class="params">following</span> <span class="params">is</span> <span class="params">done</span> <span class="params">to</span> <span class="params">avoid</span> <span class="params">a</span> <span class="params">v8</span> <span class="params">performance</span> <span class="params">cliff</span>.</span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">actualDuration</span> = <span class="params">Number</span>.<span class="params">NaN</span>;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">actualStartTime</span> = <span class="params">Number</span>.<span class="params">NaN</span>;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">selfBaseDuration</span> = <span class="params">Number</span>.<span class="params">NaN</span>;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">treeBaseDuration</span> = <span class="params">Number</span>.<span class="params">NaN</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">actualDuration</span> = 0;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">actualStartTime</span> = -1;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">selfBaseDuration</span> = 0;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">treeBaseDuration</span> = 0;</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">This</span> <span class="params">is</span> <span class="params">normally</span> <span class="params">DEV</span>-<span class="params">only</span> <span class="params">except</span> <span class="params">www</span> <span class="params">when</span> <span class="params">it</span> <span class="params">adds</span> <span class="params">listeners</span>.</span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">enableUserTimingAPI</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>._<span class="params">debugID</span> = <span class="params">debugCounter</span>++;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>._<span class="params">debugIsCurrentlyTiming</span> = <span class="params">false</span>;</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">__DEV__</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>._<span class="params">debugSource</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>._<span class="params">debugOwner</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>._<span class="params">debugNeedsRemount</span> = <span class="params">false</span>;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>._<span class="params">debugHookTypes</span> = <span class="params">null</span>;</span></span><br><span class="line"><span class="function">    <span class="params">if</span> (<span class="params">!hasBadMapPolyfill &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Object</span>.preventExtensions === '<span class="keyword">function</span>'</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">Object</span>.<span class="params">preventExtensions</span>(<span class="params"><span class="keyword">this</span></span>);</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="params">const</span> <span class="params">createFiber</span> = <span class="params">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="literal">null</span> | <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="params">Fiber</span> &#123;</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">new</span> <span class="params">FiberNode</span>(<span class="params">tag, pendingProps, key, mode</span>);</span></span><br><span class="line"><span class="function">&#125;;</span></span><br></pre></td></tr></table></figure>
<h2 id="ReactFiberRoot"><a href="#ReactFiberRoot" class="headerlink" title="ReactFiberRoot"></a>ReactFiberRoot</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BaseFiberRootProperties = &#123;|</span><br><span class="line">  <span class="comment">// The type of root (legacy, batched, concurrent, etc.)</span></span><br><span class="line">  tag: RootTag,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Any additional information from the host associated with this root.</span></span><br><span class="line">  containerInfo: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// Used only by persistent updates.</span></span><br><span class="line">  pendingChildren: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// The currently active root fiber. This is the mutable root of the tree.</span></span><br><span class="line">  current: Fiber,</span><br><span class="line"></span><br><span class="line">  pingCache:</span><br><span class="line">    | WeakMap&lt;Thenable, Set&lt;ExpirationTime&gt;&gt;</span><br><span class="line">    | Map&lt;Thenable, Set&lt;ExpirationTime&gt;&gt;</span><br><span class="line">    | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  finishedExpirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// A finished work-in-progress HostRoot that's ready to be committed.</span></span><br><span class="line">  finishedWork: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// Timeout handle returned by setTimeout. Used to cancel a pending timeout, if</span></span><br><span class="line">  <span class="comment">// it's superseded by a new one.</span></span><br><span class="line">  timeoutHandle: TimeoutHandle | NoTimeout,</span><br><span class="line">  <span class="comment">// Top context object, used by renderSubtreeIntoContainer</span></span><br><span class="line">  context: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  pendingContext: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// Determines if we should attempt to hydrate on the initial mount</span></span><br><span class="line">  +hydrate: <span class="built_in">boolean</span>,</span><br><span class="line">  <span class="comment">// Node returned by Scheduler.scheduleCallback</span></span><br><span class="line">  callbackNode: *,</span><br><span class="line">  <span class="comment">// Expiration of the callback associated with this root</span></span><br><span class="line">  callbackExpirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// Priority of the callback associated with this root</span></span><br><span class="line">  callbackPriority: ReactPriorityLevel,</span><br><span class="line">  <span class="comment">// The earliest pending expiration time that exists in the tree</span></span><br><span class="line">  firstPendingTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The earliest suspended expiration time that exists in the tree</span></span><br><span class="line">  firstSuspendedTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest suspended expiration time that exists in the tree</span></span><br><span class="line">  lastSuspendedTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The next known expiration time after the suspended range</span></span><br><span class="line">  nextKnownPendingLevel: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest time at which a suspended component pinged the root to</span></span><br><span class="line">  <span class="comment">// render again</span></span><br><span class="line">  lastPingedTime: ExpirationTime,</span><br><span class="line">  lastExpiredTime: ExpirationTime,</span><br><span class="line">|&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberRootNode</span>(<span class="params">containerInfo, tag, hydrate</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.tag = tag;</span><br><span class="line">  <span class="keyword">this</span>.current = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.containerInfo = containerInfo;</span><br><span class="line">  <span class="keyword">this</span>.pendingChildren = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.pingCache = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.finishedExpirationTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.finishedWork = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.timeoutHandle = noTimeout;</span><br><span class="line">  <span class="keyword">this</span>.context = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.pendingContext = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.hydrate = hydrate;</span><br><span class="line">  <span class="keyword">this</span>.callbackNode = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.callbackPriority = NoPriority;</span><br><span class="line">  <span class="keyword">this</span>.firstPendingTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.firstSuspendedTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.lastSuspendedTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.nextKnownPendingLevel = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.lastPingedTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.lastExpiredTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="keyword">this</span>.interactionThreadID = unstable_getThreadID();</span><br><span class="line">    <span class="keyword">this</span>.memoizedInteractions = <span class="keyword">new</span> Set();</span><br><span class="line">    <span class="keyword">this</span>.pendingInteractionMap = <span class="keyword">new</span> Map();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (enableSuspenseCallback) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hydrationCallbacks = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ReactWorkTag"><a href="#ReactWorkTag" class="headerlink" title="ReactWorkTag"></a>ReactWorkTag</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FunctionComponent = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ClassComponent = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IndeterminateComponent = <span class="number">2</span>; <span class="comment">// Before we know whether it is function or class</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostRoot = <span class="number">3</span>; <span class="comment">// Root of a host tree. Could be nested inside another node.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostPortal = <span class="number">4</span>; <span class="comment">// A subtree. Could be an entry point to a different renderer.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostComponent = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostText = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Fragment = <span class="number">7</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Mode = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContextConsumer = <span class="number">9</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContextProvider = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ForwardRef = <span class="number">11</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Profiler = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SuspenseComponent = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> MemoComponent = <span class="number">14</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SimpleMemoComponent = <span class="number">15</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LazyComponent = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IncompleteClassComponent = <span class="number">17</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Update-amp-UpdateQueue"><a href="#Update-amp-UpdateQueue" class="headerlink" title="Update &amp; UpdateQueue"></a>Update &amp; UpdateQueue</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Update&lt;State&gt; = &#123;</span><br><span class="line">  <span class="comment">// 更新的过期时间</span></span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// export const UpdateState = 0;</span></span><br><span class="line">  <span class="comment">// export const ReplaceState = 1;</span></span><br><span class="line">  <span class="comment">// export const ForceUpdate = 2;</span></span><br><span class="line">  <span class="comment">// export const CaptureUpdate = 3;</span></span><br><span class="line">  <span class="comment">// 指定更新的类型，值为以上几种</span></span><br><span class="line">  tag: <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>,</span><br><span class="line">  <span class="comment">// 更新内容，比如`setState`接收的第一个参数</span></span><br><span class="line">  payload: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// 对应的回调，`setState`，`render`都有</span></span><br><span class="line">  callback: <span class="function">(<span class="params">(<span class="params"></span>) =&gt; mixed</span>) | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 指向下一个更新</span></span><br><span class="line"><span class="function">  <span class="params">next</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">  // 指向下一个`<span class="params">side</span> <span class="params">effect</span>`</span></span><br><span class="line"><span class="function">  <span class="params">nextEffect</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">&#125;;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="params">export</span> <span class="params">type</span> <span class="params">UpdateQueue</span>&lt;<span class="params">State</span>&gt; = &#123;</span></span><br><span class="line"><span class="function">  // 每次操作完更新之后的`<span class="params">state</span>`</span></span><br><span class="line"><span class="function">  <span class="params">baseState</span>: <span class="params">State</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 队列中的第一个`<span class="params">Update</span>`</span></span><br><span class="line"><span class="function">  <span class="params">firstUpdate</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">  // 队列中的最后一个`<span class="params">Update</span>`</span></span><br><span class="line"><span class="function">  <span class="params">lastUpdate</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 第一个捕获类型的`<span class="params">Update</span>`</span></span><br><span class="line"><span class="function">  <span class="params">firstCapturedUpdate</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">  // 最后一个捕获类型的`<span class="params">Update</span>`</span></span><br><span class="line"><span class="function">  <span class="params">lastCapturedUpdate</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 第一个`<span class="params">side</span> <span class="params">effect</span>`</span></span><br><span class="line"><span class="function">  <span class="params">firstEffect</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">  // 最后一个`<span class="params">side</span> <span class="params">effect</span>`</span></span><br><span class="line"><span class="function">  <span class="params">lastEffect</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 第一个和最后一个捕获产生的`<span class="params">side</span> <span class="params">effect</span>`</span></span><br><span class="line"><span class="function">  <span class="params">firstCapturedEffect</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">  <span class="params">lastCapturedEffect</span>: <span class="params">Update</span>&lt;<span class="params">State</span>&gt; | <span class="params">null</span>,</span></span><br><span class="line"><span class="function">&#125;;</span></span><br></pre></td></tr></table></figure>
<h2 id="ExpirationTime"><a href="#ExpirationTime" class="headerlink" title="ExpirationTime"></a>ExpirationTime</h2><p>一些优先级和预设常数</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> ReactPriorityLevel = <span class="number">99</span> | <span class="number">98</span> | <span class="number">97</span> | <span class="number">96</span> | <span class="number">95</span> | <span class="number">90</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ImmediatePriority: ReactPriorityLevel = <span class="number">99</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UserBlockingPriority: ReactPriorityLevel = <span class="number">98</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NormalPriority: ReactPriorityLevel = <span class="number">97</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LowPriority: ReactPriorityLevel = <span class="number">96</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IdlePriority: ReactPriorityLevel = <span class="number">95</span>;</span><br><span class="line"><span class="comment">// NoPriority is the absence of priority. Also React-only.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoPriority: ReactPriorityLevel = <span class="number">90</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoWork = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Never = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// Idle is slightly higher priority than Never. It must completely finish in</span></span><br><span class="line"><span class="comment">// order to be consistent.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Idle = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// Continuous Hydration is a moving priority. It is slightly higher than Idle</span></span><br><span class="line"><span class="comment">// and is used to increase priority of hover targets. It is increasing with</span></span><br><span class="line"><span class="comment">// each usage so that last always wins.</span></span><br><span class="line"><span class="keyword">let</span> ContinuousHydration = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Sync = MAX_SIGNED_31_BIT_INT;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Batched = Sync - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UNIT_SIZE = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> MAGIC_NUMBER_OFFSET = Batched - <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>获取currentTime</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> now =</span><br><span class="line">  initialTimeMs &lt; <span class="number">10000</span> ? Scheduler_now : <span class="function"><span class="params">()</span> =&gt;</span> Scheduler_now() - initialTimeMs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getCurrentTime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> msToExpirationTime(now());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>expirationTime基本计算方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1 unit of expiration time represents 10ms.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">msToExpirationTime</span>(<span class="params">ms: <span class="built_in">number</span></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Always add an offset so that we don't clash with the magic number for NoWork.</span></span><br><span class="line">  <span class="comment">//"|0"就是取整</span></span><br><span class="line">  <span class="keyword">return</span> MAGIC_NUMBER_OFFSET - ((ms / UNIT_SIZE) | <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">expirationTimeToMs</span>(<span class="params">expirationTime: ExpirationTime</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (MAGIC_NUMBER_OFFSET - expirationTime) * UNIT_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ceiling</span>(<span class="params">num: <span class="built_in">number</span>, precision: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (((num / precision) | <span class="number">0</span>) + <span class="number">1</span>) * precision;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeExpirationBucket</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentTime,  <span class="comment">//当前时间戳</span></span></span></span><br><span class="line"><span class="function"><span class="params">  expirationInMs,</span></span></span><br><span class="line"><span class="function"><span class="params">  bucketSizeMs,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    MAGIC_NUMBER_OFFSET -</span><br><span class="line">    ceiling(</span><br><span class="line">      MAGIC_NUMBER_OFFSET - currentTime + expirationInMs / UNIT_SIZE,</span><br><span class="line">      bucketSizeMs / UNIT_SIZE,</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LOW_PRIORITY_EXPIRATION = <span class="number">5000</span>;</span><br><span class="line"><span class="comment">//用于batchedUpdate?</span></span><br><span class="line"><span class="comment">//相近的几次更新最后算出来是同一个expirationTime</span></span><br><span class="line"><span class="comment">//这样就可以自动合并在同一次更新中完成</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LOW_PRIORITY_BATCH_SIZE = <span class="number">250</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//异步超时</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computeAsyncExpiration</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> computeExpirationBucket(</span><br><span class="line">    currentTime,</span><br><span class="line">    LOW_PRIORITY_EXPIRATION,</span><br><span class="line">    LOW_PRIORITY_BATCH_SIZE,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中断超时</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computeSuspenseExpiration</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  timeoutMs: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> computeExpirationBucket(</span><br><span class="line">    currentTime,</span><br><span class="line">    timeoutMs,</span><br><span class="line">    LOW_PRIORITY_BATCH_SIZE,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HIGH_PRIORITY_EXPIRATION = __DEV__ ? <span class="number">500</span> : <span class="number">150</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HIGH_PRIORITY_BATCH_SIZE = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//交互超时（响应优先级高）</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computeInteractiveExpiration</span>(<span class="params">currentTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> computeExpirationBucket(</span><br><span class="line">    currentTime,  </span><br><span class="line">    HIGH_PRIORITY_EXPIRATION,</span><br><span class="line">    HIGH_PRIORITY_BATCH_SIZE,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//连续"注水"超时</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computeContinuousHydrationExpiration</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Each time we ask for a new one of these we increase the priority.</span></span><br><span class="line">  <span class="comment">// This ensures that the last one always wins since we can't deprioritize</span></span><br><span class="line">  <span class="comment">// once we've scheduled work already.</span></span><br><span class="line">  <span class="keyword">return</span> ContinuousHydration++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据超时推断优先级</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">inferPriorityFromExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ReactPriorityLevel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (expirationTime === Sync) &#123;</span><br><span class="line">    <span class="keyword">return</span> ImmediatePriority;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (expirationTime === Never || expirationTime === Idle) &#123;</span><br><span class="line">    <span class="keyword">return</span> IdlePriority;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> msUntil =</span><br><span class="line">    expirationTimeToMs(expirationTime) - expirationTimeToMs(currentTime);</span><br><span class="line">  <span class="keyword">if</span> (msUntil &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> ImmediatePriority;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (msUntil &lt;= HIGH_PRIORITY_EXPIRATION + HIGH_PRIORITY_BATCH_SIZE) &#123;</span><br><span class="line">    <span class="keyword">return</span> UserBlockingPriority;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (msUntil &lt;= LOW_PRIORITY_EXPIRATION + LOW_PRIORITY_BATCH_SIZE) &#123;</span><br><span class="line">    <span class="keyword">return</span> NormalPriority;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> IdlePriority;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>计算Fiber超时</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computeExpirationForFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  currentTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  suspenseConfig: <span class="literal">null</span> | SuspenseConfig,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mode = fiber.mode;</span><br><span class="line">  <span class="keyword">if</span> ((mode &amp; BlockingMode) === NoMode) &#123;</span><br><span class="line">    <span class="keyword">return</span> Sync;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel();</span><br><span class="line">  <span class="keyword">if</span> ((mode &amp; ConcurrentMode) === NoMode) &#123;</span><br><span class="line">    <span class="keyword">return</span> priorityLevel === ImmediatePriority ? Sync : Batched;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((executionContext &amp; RenderContext) !== NoContext) &#123;</span><br><span class="line">    <span class="comment">// Use whatever time we're already rendering</span></span><br><span class="line">    <span class="keyword">return</span> renderExpirationTime;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (suspenseConfig !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Compute an expiration time based on the Suspense timeout.</span></span><br><span class="line">    expirationTime = computeSuspenseExpiration(</span><br><span class="line">      currentTime,</span><br><span class="line">      suspenseConfig.timeoutMs | <span class="number">0</span> || LOW_PRIORITY_EXPIRATION,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Compute an expiration time based on the Scheduler priority.</span></span><br><span class="line">    <span class="keyword">switch</span> (priorityLevel) &#123;</span><br><span class="line">      <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">        expirationTime = Sync;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">        expirationTime = computeInteractiveExpiration(currentTime);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> NormalPriority:</span><br><span class="line">      <span class="keyword">case</span> LowPriority: </span><br><span class="line">        expirationTime = computeAsyncExpiration(currentTime);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> IdlePriority:</span><br><span class="line">        expirationTime = Idle;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        invariant(<span class="literal">false</span>, <span class="string">'Expected a valid priority level'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we're in the middle of rendering a tree, do not update at the same</span></span><br><span class="line">  <span class="comment">// expiration time that is already rendering.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRoot !== <span class="literal">null</span> &amp;&amp; expirationTime === renderExpirationTime) &#123;</span><br><span class="line">    <span class="comment">// This is a trick to move this update into a separate batch</span></span><br><span class="line">    expirationTime -= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="react-dom包"><a href="#react-dom包" class="headerlink" title="react-dom包"></a>react-dom包</h1><h2 id="ReactDOM-properties"><a href="#ReactDOM-properties" class="headerlink" title="ReactDOM properties"></a>ReactDOM properties</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ReactDOM: <span class="built_in">Object</span> = &#123;</span><br><span class="line">  createPortal,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Legacy</span></span><br><span class="line">  findDOMNode,</span><br><span class="line">  hydrate,</span><br><span class="line">  render,</span><br><span class="line">  unmountComponentAtNode,</span><br><span class="line"></span><br><span class="line">  unstable_batchedUpdates: batchedUpdates,</span><br><span class="line"></span><br><span class="line">  flushSync: flushSync,</span><br><span class="line"></span><br><span class="line">  __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED: &#123;</span><br><span class="line">    <span class="comment">//...233</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="ReactDOM-render"><a href="#ReactDOM-render" class="headerlink" title="ReactDOM.render"></a>ReactDOM.render</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//render</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: React$Element&lt;<span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    isValidContainer(container),</span><br><span class="line">    <span class="string">'Target container is not a DOM element.'</span>,</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    element,</span><br><span class="line">    container,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    callback,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> root: RootType = (container._reactRootContainer: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">let</span> fiberRoot;</span><br><span class="line">  <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">    <span class="comment">// Initial mount</span></span><br><span class="line">    <span class="comment">// 初次渲染，创建root</span></span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate,</span><br><span class="line">    );</span><br><span class="line">    fiberRoot = root._internalRoot;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = getPublicRootInstance(fiberRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Initial mount should not be batched.</span></span><br><span class="line">    <span class="comment">//初次渲染不使用batchedUpdate，即时完成</span></span><br><span class="line">    unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//非初次渲染</span></span><br><span class="line">    fiberRoot = root._internalRoot;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = getPublicRootInstance(fiberRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update</span></span><br><span class="line">    <span class="comment">//这个update函数后面说</span></span><br><span class="line">    updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> getPublicRootInstance(fiberRoot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//上面用到的创建root方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyCreateRootFromDOMContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> shouldHydrate =</span><br><span class="line">    forceHydrate || shouldHydrateDueToLegacyHeuristic(container);</span><br><span class="line">  <span class="comment">// First clear any existing content.</span></span><br><span class="line">  <span class="keyword">if</span> (!shouldHydrate) &#123;</span><br><span class="line">    <span class="keyword">let</span> warned = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> rootSibling;</span><br><span class="line">    <span class="comment">//去掉container里可能包裹的内容</span></span><br><span class="line">    <span class="keyword">while</span> ((rootSibling = container.lastChild)) &#123;</span><br><span class="line">      container.removeChild(rootSibling);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//服务端渲染最好使用hydrate()，否则警告</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldHydrate &amp;&amp; !forceHydrate &amp;&amp; !warnedAboutHydrateAPI) &#123;</span><br><span class="line">      warnedAboutHydrateAPI = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createLegacyRoot(</span><br><span class="line">    container,</span><br><span class="line">    shouldHydrate</span><br><span class="line">      ? &#123;</span><br><span class="line">          hydrate: <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      : <span class="literal">undefined</span>,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//legacyRenderSubtreeIntoContainer用到的root获取实例的方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getPublicRootInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">React$Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; | <span class="title">PublicInstance</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> containerFiber = container.current;</span><br><span class="line">  <span class="keyword">if</span> (!containerFiber.child) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (containerFiber.child.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      <span class="keyword">return</span> getPublicInstance(containerFiber.child.stateNode);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> containerFiber.child.stateNode;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = container.current;</span><br><span class="line">  <span class="keyword">const</span> currentTime = requestCurrentTimeForUpdate();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> suspenseConfig = requestCurrentSuspenseConfig();</span><br><span class="line">  <span class="comment">//计算超时时间</span></span><br><span class="line">  <span class="keyword">const</span> expirationTime = computeExpirationForFiber(</span><br><span class="line">    currentTime,</span><br><span class="line">    current,</span><br><span class="line">    suspenseConfig,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = getContextForSubtree(parentComponent);</span><br><span class="line">  <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">    container.context = context;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.pendingContext = context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(expirationTime, suspenseConfig);</span><br><span class="line"></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    update.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  enqueueUpdate(current, update);</span><br><span class="line">  scheduleWork(current, expirationTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UpdateQueue：</strong>UpdateQueue is a linked list of prioritized updates.  Like fibers, update queues come in pairs: a current queue, which represent the visible state of the screen, and a work-in-progress queue, which can be mutated and processed asynchronously before it is committed — a form of double buffering. If a work-in-progress render is discarded before finishing, we create a new work-in-progress by cloning the current queue.</p>
<blockquote>
<p>For example:</p>
<p>​      Current pointer:                     A - B - C - D - E - F</p>
<p>​      Work-in-progress pointer:                     D - E - F</p>
<p>The work-in-progress queue has processed more updates than current.</p>
</blockquote>
<p>The reason we append to both queues is because otherwise we might drop updates without ever processing them. For example, if we only add updates to the work-in-progress queue, some updates could be lost whenever a work-in-progress render restarts by cloning from current. Similarly, if we only add updates to the current queue, the updates will be lost whenever an already in-progress queue commits and swaps with the current queue. However, by adding to both queues, we guarantee that the update will be part of the next work-in-progress. (And because the work-in-progress queue becomes the current queue once it commits, there’s no danger of applying the same update twice.)</p>
<p><strong>Prioritization</strong></p>
<p>Updates are not sorted by priority, but <strong>by insertion</strong>; new updates are always appended to the end of the list. The priority is still important, though. When processing the update queue during the render phase, only the updates with sufficient priority are included in the result. If we skip an update because it has insufficient priority, it remains in the queue to be processed later, during a lower priority render. Crucially, all updates subsequent to a skipped update also remain in the queue <strong>regardless of their priority</strong>. That means high priority updates are sometimes processed twice, at two separate priorities. We also keep track of a base state, that represents the state before the first update in the queue is applied.</p>
<p>For example: </p>
<blockquote>
<p>   Given a base state of ‘’, and the following queue of updates:</p>
<p>​            A1 - B2 - C1 - D2</p>
<p>   where the number indicates the priority, and the update is applied to the previous state by appending a letter, React will process these updates as two separate renders, one per distinct priority level:</p>
<p>   First render, at priority 1:</p>
<p>​           Base state: ‘’</p>
<p>​           Updates: [A1, C1]</p>
<p>​           Result state: ‘AC’</p>
<p>   Second render, at priority 2:</p>
<p>​           Base state: ‘A’         &lt;-  The base state does not include C1, because B2 was skipped.</p>
<p>​           Updates: [B2, C1, D2]      &lt;-  C1 was rebased on top of B2</p>
<p>​           Result state: ‘ABCD’</p>
</blockquote>
<p>Because we process updates in insertion order, and rebase high priority updates when preceding(前面的) updates are skipped, the final result is deterministic <strong>regardless of priority</strong>. Intermediate state may vary according to system resources, but <strong>the final state is always the same</strong>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params">fiber: Fiber, update: Update&lt;State&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.updateQueue;</span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Only occurs if the fiber has been unmounted.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.shared;</span><br><span class="line">  <span class="keyword">const</span> pending = sharedQueue.pending;</span><br><span class="line">  <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">    update.next = update;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    update.next = pending.next;</span><br><span class="line">    pending.next = update;</span><br><span class="line">  &#125;</span><br><span class="line">  sharedQueue.pending = update;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="findDOMNode"><a href="#findDOMNode" class="headerlink" title="findDOMNode"></a>findDOMNode</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">findDOMNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  componentOrElement: Element | ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">null</span> | <span class="title">Element</span> | <span class="title">Text</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (componentOrElement == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((componentOrElement: <span class="built_in">any</span>).nodeType === ELEMENT_NODE) &#123;</span><br><span class="line">    <span class="keyword">return</span> (componentOrElement: <span class="built_in">any</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> findHostInstance(componentOrElement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ReactDOM-hydrate"><a href="#ReactDOM-hydrate" class="headerlink" title="ReactDOM.hydrate"></a>ReactDOM.hydrate</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">hydrate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: React$Node,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    isValidContainer(container),</span><br><span class="line">    <span class="string">'Target container is not a DOM element.'</span>,</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    element,</span><br><span class="line">    container,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    callback,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="shared包"><a href="#shared包" class="headerlink" title="shared包"></a>shared包</h1><h2 id="Object-is-polyfill"><a href="#Object-is-polyfill" class="headerlink" title="Object.is polyfill"></a>Object.is polyfill</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is</span>(<span class="params">x: <span class="built_in">any</span>, y: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    (x === y &amp;&amp; (x !== <span class="number">0</span> || <span class="number">1</span> / x === <span class="number">1</span> / y)) || (x !== x &amp;&amp; y !== y) <span class="comment">// eslint-disable-line no-self-compare</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> objectIs: <span class="function">(<span class="params">x: <span class="built_in">any</span>, y: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">boolean</span> =</span><br><span class="line">  <span class="keyword">typeof</span> <span class="built_in">Object</span>.is === <span class="string">'function'</span> ? <span class="built_in">Object</span>.is : is;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> objectIs;</span><br></pre></td></tr></table></figure>
<h2 id="shallowEqual"><a href="#shallowEqual" class="headerlink" title="shallowEqual"></a>shallowEqual</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> is <span class="keyword">from</span> <span class="string">'./objectIs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasOwnProperty = <span class="built_in">Object</span>.prototype.hasOwnProperty;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Performs equality by iterating through keys on an object and returning false</span></span><br><span class="line"><span class="comment"> * when any key has values which are not strictly equal between the arguments.</span></span><br><span class="line"><span class="comment"> * Returns true when the values of all keys are strictly equal.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shallowEqual</span>(<span class="params">objA: mixed, objB: mixed</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (is(objA, objB)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> objA !== <span class="string">'object'</span> ||</span><br><span class="line">    objA === <span class="literal">null</span> ||</span><br><span class="line">    <span class="keyword">typeof</span> objB !== <span class="string">'object'</span> ||</span><br><span class="line">    objB === <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> keysA = <span class="built_in">Object</span>.keys(objA);</span><br><span class="line">  <span class="keyword">const</span> keysB = <span class="built_in">Object</span>.keys(objB);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keysA.length !== keysB.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Test for A's keys different from B.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keysA.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !hasOwnProperty.call(objB, keysA[i]) ||</span><br><span class="line">      !is(objA[keysA[i]], objB[keysA[i]])</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> shallowEqual;</span><br></pre></td></tr></table></figure>
<h2 id="endsWith"><a href="#endsWith" class="headerlink" title="endsWith"></a>endsWith</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">endsWith</span>(<span class="params">subject: <span class="built_in">string</span>, search: <span class="built_in">string</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> length = subject.length;</span><br><span class="line">  <span class="keyword">return</span> subject.substring(length - search.length, length) === search;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </article>
    <!-- license  -->
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/2020/01/22/重读React文档的一些记录/" title= 重读React文档的一些记录 >
                    <div class="prevTitle">重读React文档的一些记录</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!--PC和WAP自适应版-->

    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:643342586@qq.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/CallMeSaltyF1sh" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#React"><span class="toc-number">1.</span> <span class="toc-text">React</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Component和PureComponent"><span class="toc-number">1.1.</span> <span class="toc-text">Component和PureComponent</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Component属性"><span class="toc-number">1.1.1.</span> <span class="toc-text">Component属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setState"><span class="toc-number">1.1.2.</span> <span class="toc-text">setState</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#forceUpdate"><span class="toc-number">1.1.3.</span> <span class="toc-text">forceUpdate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PureComponent"><span class="toc-number">1.1.4.</span> <span class="toc-text">PureComponent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactElement"><span class="toc-number">1.2.</span> <span class="toc-text">ReactElement</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本构成"><span class="toc-number">1.2.1.</span> <span class="toc-text">基本构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createElement"><span class="toc-number">1.2.2.</span> <span class="toc-text">createElement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cloneElement"><span class="toc-number">1.2.3.</span> <span class="toc-text">cloneElement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Verify-ReactElement"><span class="toc-number">1.2.4.</span> <span class="toc-text">Verify ReactElement</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#React-Children"><span class="toc-number">1.3.</span> <span class="toc-text">React Children</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#map"><span class="toc-number">1.3.1.</span> <span class="toc-text">map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#forEach"><span class="toc-number">1.3.2.</span> <span class="toc-text">forEach</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactContext"><span class="toc-number">1.4.</span> <span class="toc-text">ReactContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createRef"><span class="toc-number">1.5.</span> <span class="toc-text">createRef</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#memo"><span class="toc-number">1.6.</span> <span class="toc-text">memo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#forwardRef"><span class="toc-number">1.7.</span> <span class="toc-text">forwardRef</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#react-reconciler-React-Fiber"><span class="toc-number">2.</span> <span class="toc-text">react-reconciler (React Fiber)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#intro"><span class="toc-number">2.1.</span> <span class="toc-text">intro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactFiber"><span class="toc-number">2.2.</span> <span class="toc-text">ReactFiber</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactFiberRoot"><span class="toc-number">2.3.</span> <span class="toc-text">ReactFiberRoot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactWorkTag"><span class="toc-number">2.4.</span> <span class="toc-text">ReactWorkTag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Update-amp-UpdateQueue"><span class="toc-number">2.5.</span> <span class="toc-text">Update &amp; UpdateQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExpirationTime"><span class="toc-number">2.6.</span> <span class="toc-text">ExpirationTime</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#react-dom包"><span class="toc-number">3.</span> <span class="toc-text">react-dom包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactDOM-properties"><span class="toc-number">3.1.</span> <span class="toc-text">ReactDOM properties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactDOM-render"><span class="toc-number">3.2.</span> <span class="toc-text">ReactDOM.render</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#findDOMNode"><span class="toc-number">3.3.</span> <span class="toc-text">findDOMNode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactDOM-hydrate"><span class="toc-number">3.4.</span> <span class="toc-text">ReactDOM.hydrate</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#shared包"><span class="toc-number">4.</span> <span class="toc-text">shared包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Object-is-polyfill"><span class="toc-number">4.1.</span> <span class="toc-text">Object.is polyfill</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shallowEqual"><span class="toc-number">4.2.</span> <span class="toc-text">shallowEqual</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#endsWith"><span class="toc-number">4.3.</span> <span class="toc-text">endsWith</span></a></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 12
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2020 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/29</span><a class="archive-post-title" href= "/2020/01/29/React源码阅读/" >React源码阅读</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/22</span><a class="archive-post-title" href= "/2020/01/22/重读React文档的一些记录/" >重读React文档的一些记录</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/06</span><a class="archive-post-title" href= "/2019/08/06/ES6常用新特性整理/" >ES6常用新特性整理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/25</span><a class="archive-post-title" href= "/2019/07/25/Redux学习笔记/" >Redux学习笔记</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span><a class="archive-post-title" href= "/2019/07/08/使用express-MySQL实现数据接口并部署/" >使用express+MySQL实现数据接口并部署</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/05</span><a class="archive-post-title" href= "/2019/07/05/JavaScript数据结构与算法学习/" >JavaScript数据结构与算法学习</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/02</span><a class="archive-post-title" href= "/2019/04/02/JS之闭包和原型那些事儿/" >JS之闭包和原型那些事儿</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/05</span><a class="archive-post-title" href= "/2019/02/05/Ajax学习笔记/" >Ajax学习笔记</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2018 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/12</span><a class="archive-post-title" href= "/2018/11/12/深入学习CSS布局/" >深入学习CSS布局</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/31</span><a class="archive-post-title" href= "/2018/08/31/Sqli-Labs-Study/" >Sqli-Labs Study</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/25</span><a class="archive-post-title" href= "/2018/08/25/Bugku-SQL注入题目总结/" >Bugku SQL注入题目总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/11</span><a class="archive-post-title" href= "/2018/08/11/New-Start/" >New Start</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="SQL"><span class="iconfont-archer">&#xe606;</span>SQL</span>
    
        <span class="sidebar-tag-name" data-tags="BugkuCTF"><span class="iconfont-archer">&#xe606;</span>BugkuCTF</span>
    
        <span class="sidebar-tag-name" data-tags="Ajax"><span class="iconfont-archer">&#xe606;</span>Ajax</span>
    
        <span class="sidebar-tag-name" data-tags="Life"><span class="iconfont-archer">&#xe606;</span>Life</span>
    
        <span class="sidebar-tag-name" data-tags="Node.js"><span class="iconfont-archer">&#xe606;</span>Node.js</span>
    
        <span class="sidebar-tag-name" data-tags="Express"><span class="iconfont-archer">&#xe606;</span>Express</span>
    
        <span class="sidebar-tag-name" data-tags="MySQL"><span class="iconfont-archer">&#xe606;</span>MySQL</span>
    
        <span class="sidebar-tag-name" data-tags="Javascript"><span class="iconfont-archer">&#xe606;</span>Javascript</span>
    
        <span class="sidebar-tag-name" data-tags="数据结构与算法"><span class="iconfont-archer">&#xe606;</span>数据结构与算法</span>
    
        <span class="sidebar-tag-name" data-tags="Redux"><span class="iconfont-archer">&#xe606;</span>Redux</span>
    
        <span class="sidebar-tag-name" data-tags="CSS"><span class="iconfont-archer">&#xe606;</span>CSS</span>
    
        <span class="sidebar-tag-name" data-tags="ES6"><span class="iconfont-archer">&#xe606;</span>ES6</span>
    
        <span class="sidebar-tag-name" data-tags="React"><span class="iconfont-archer">&#xe606;</span>React</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "John Doe"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


